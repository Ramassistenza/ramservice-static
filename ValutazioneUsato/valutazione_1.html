<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Valutazione Smartphone Step-by-Step</title>
<style>
/* ================= BASE ================= */
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
  color: #333;
}
.container {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 25px;
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
}

/* ================= BARRA PROGRESSO ================= */
.progress-bar {
  grid-column: 1/-1;
  width: 100%;
  background: #d1e0ff;
  height: 28px;
  border-radius: 14px;
  overflow: hidden;
  margin-bottom: 30px;
  position: relative;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}
.progress {
  height: 100%;
  background: linear-gradient(90deg,#0066cc,#00aaff);
  width: 0%;
  border-radius: 14px;
  transition: width 0.5s ease-in-out;
}
.progress-text {
  position: absolute;
  width: 100%;
  text-align: center;
  top: 0;
  line-height: 28px;
  font-weight: 700;
  color: #fff;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
  font-size: 14px;
}

/* ================= SEZIONE STEP ================= */
.step-section {
  background: #fff;
  padding: 35px 30px;
  border-radius: 18px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.12);
  display: flex;
  flex-direction: column;
  gap: 25px;
}
.step-section h2 {
  margin-top: 0;
  color: #005fa3;
  font-weight: 700;
  font-size: 26px;
  text-align: center;
}
.step-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* LABEL E INPUT */
label {
  display: block;
  margin-top: 12px;
  font-weight: 600;
  color: #444;
}
.description {
  font-size: 13px;
  color: #666;
  margin-top: 5px;
}
select, input[type="number"] {
  width: 100%;
  padding: 12px 14px;
  margin-top: 8px;
  font-size: 15px;
  border-radius: 10px;
  border: 1px solid #bbb;
  transition: border 0.3s, box-shadow 0.3s;
}
select:focus, input[type="number"]:focus {
  border-color: #0077cc;
  box-shadow: 0 0 6px rgba(0,119,204,0.3);
  outline: none;
}

/* PULSANTI */
button {
  background: #0077cc;
  color: #fff;
  border: none;
  font-weight: 700;
  padding: 13px 22px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
}
button:hover { 
  background: #005fa3; 
  transform: translateY(-2px);
}
button.secondary { 
  background: #555; 
}
button.secondary:hover { 
  background: #333; 
}

/* ================= RIEPILOGO + PREZZO ================= */
.summary {
  background: #fff;
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.12);
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.summary h2 {
  margin-top: 0;
  font-weight: 700;
  color: #005fa3;
  font-size: 22px;
  text-align: center;
}
.summary p { 
  margin: 6px 0; 
  font-size: 15px;
}
.price-box {
  margin-top: 20px;
  background: #e6f0ff;
  padding: 22px;
  border-radius: 14px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 26px;
  font-weight: 700;
  color: #0077cc;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* ================= LOGO + FOTO SOTTO PULSANTI ================= */
.logo-foto-container {
  display: flex;
  gap: 25px;
  justify-content: center;
  margin-top: 25px;
  flex-wrap: wrap;
}
.logo-box, .foto-box {
  background: #fff;
  padding: 20px;
  border-radius: 18px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  display: flex;
  justify-content: center;
  align-items: center;
  width: 220px;
  height: 220px;
}
.logo-box img, .foto-box img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
}

/* ================= ANIMAZIONI ================= */
.fade-enter { opacity:0; transform:translateY(20px); }
.fade-enter-active { opacity:1; transform:translateY(0); transition:all 0.5s; }
.fade-exit { opacity:1; transform:translateY(0); }
.fade-exit-active { opacity:0; transform:translateY(-20px); transition:all 0.5s; }

/* ================= RESPONSIVE ================= */
@media (max-width: 1000px) {
  .container { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
  .logo-box, .foto-box { width: 180px; height: 180px; }
  .step-section, .summary { padding: 22px; }
  .price-box { font-size: 22px; padding: 18px; }
}
</style>
</head>
<body>

<!-- BARRA PROGRESSO -->
<div class="progress-bar">
  <div class="progress" id="progress"></div>
  <div class="progress-text" id="progressText">0%</div>
</div>

<div class="container">

  <!-- STEP -->
  <div class="step-section" id="stepsCol">
    <h2>Valutazione Smartphone</h2>
    <div id="stepContainer"></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button id="nextBtn">Avanti</button>
      <button id="showPriceBtn" style="display:none;" onclick="calcolaPrezzo()">Mostra Prezzo</button>
      <button id="restartBtn" class="secondary" onclick="ricomincia()">Ricomincia</button>
    </div>

    <!-- LOGO + FOTO SOTTO PULSANTI -->
    <div class="logo-foto-container">
      <div class="logo-box" id="logoMarcaBox"><img id="logoMarca" src="" alt="Logo Marca"></div>
      <div class="foto-box" id="fotoProdottoBox"><img id="fotoProdotto" src="" alt="Foto Prodotto"></div>
    </div>
  </div>

  <!-- RIEPILOGO -->
  <div class="summary" id="summaryCol">
    <h2>Riepilogo selezioni</h2>
    <p id="sum_marca">Marca: -</p>
    <p id="sum_modello">Modello: -</p>
    <p id="sum_memoria">Memoria: -</p>
    <p id="sum_batteria">Batteria: -</p>
    <p id="sum_funzioni">Funzioni: -</p>
    <p id="sum_display">Display: -</p>
    <p id="sum_retro">Retro: -</p>
    <p id="sum_account">Account: -</p>
    <div class="price-box" id="priceBox">Prezzo Valutazione</div>
  </div>

</div>

<!-- SCRIPT ORIGINALE (INVARIATO) -->
<script>
/* --- SCRIPT IDENTICO (NESSUNA LOGICA CAMBIATA) --- */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTALk9G-bdD_eitOcDhLV-z_kG0SrRwTeDjVoyBFwjlgjwisSk3h9gOAMur5pMOoxKDKV3cwQ9woxlr/pub?gid=2070797727&single=true&output=csv";
let data = [], step = 0, risposte = {};
const steps = [];

const descriptions = {
  "marca":"Inserisci la marca del tuo Smartphone;",
  "modello":"Inserisci il modello;",
  "memoria":"Inserisci la capacità della memoria del tuo dispositivo;",
  "batteria":"Controlla la capacità massima della batteria. Si trova in Impostazioni -> Batteria -> Stato batteria",
  "funzioni":"Il dispositivo si accende, si ricarica e si connette alla rete. Ha altoparlanti, microfoni e fotocamere funzionanti.",
  "display":"Controlla la presenza di macchie luminose, pixel bruciati o linee/segni di burn in (scolorimento), o se sono presenti crepe e rotture dei cristalli.",
  "retro":"Controlla il retro per graffi, crepe e segni di usura.",
  "account":""
};

async function caricaCSV() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const righe = text.trim().split("\n").map(r => r.split(","));
  righe.shift(); // intestazioni
  data = righe.map(r => ({Marca:r[0], Modello:r[1], Memoria:r[2], PrezzoBase:parseFloat(r[3]), Foto:r[4]}));
  inizializzaSteps();
  mostraStep();
}

function inizializzaSteps() {
  steps.push({id:"marca", label:"Seleziona Marca", type:"select", options:[...new Set(data.map(d=>d.Marca))]});
  steps.push({id:"modello", label:"Seleziona Modello", type:"select", options:[], depends:"marca"});
  steps.push({id:"memoria", label:"Seleziona Memoria", type:"select", options:[], depends:"modello"});
  steps.push({id:"batteria", label:"Salute batteria (%)", type:"number", min:1, max:100, default:100});
  steps.push({id:"funzioni", label:"Il telefono funziona perfettamente o ha qualche problema?", type:"select", options:["Si, funziona perfettamente","No, funziona parzialmente"]});
  steps.push({id:"display", label:"Condizioni Display", type:"select", options:["No, ha il display rotto","Si, ma presenta graffi ben visibili","Si, ma graffi impercettibili","Si, come nuovo"]});
  steps.push({id:"retro", label:"Condizioni retro", type:"select", options:["Il vetro è crepato","Integro ma presenta graffi","Integro e perfetto"]});
  steps.push({id:"account", label:"Account e blocchi utente rimossi?", type:"select", options:["Si","No"]});
}

function mostraStep() {
  const container = document.getElementById("stepContainer");
  container.innerHTML = "";

  document.getElementById("restartBtn").style.display="inline-block";

  if(step >= steps.length) { 
    document.getElementById("nextBtn").style.display="none";
    document.getElementById("showPriceBtn").style.display="inline-block";
    aggiornaProgress();
    return;
  }

  document.getElementById("nextBtn").style.display="inline-block";
  document.getElementById("showPriceBtn").style.display="none";

  const s = steps[step];
  const wrapper = document.createElement("div");
  wrapper.classList.add("fade-enter");
  setTimeout(()=>wrapper.classList.add("fade-enter-active"),10);

  const label = document.createElement("label");
  label.textContent = s.label;
  wrapper.appendChild(label);

  if(descriptions[s.id]){
    const desc = document.createElement("div");
    desc.className = "description";
    desc.textContent = descriptions[s.id];
    wrapper.appendChild(desc);
  }

  let input;
  if(s.type==="select"){
    input = document.createElement("select");
    input.id=s.id;
    let opts = s.options;
    if(s.depends==="marca") opts = [...new Set(data.filter(d=>d.Marca===risposte["marca"]).map(d=>d.Modello))];
    if(s.depends==="modello") opts = [...new Set(data.filter(d=>d.Marca===risposte["marca"] && d.Modello===risposte["modello"]).map(d=>d.Memoria))];
    input.innerHTML = "<option value=''>-- Seleziona --</option>"+opts.map(o=>`<option value="${o}">${o}</option>`).join("");
  } else if(s.type==="number"){
    input = document.createElement("input");
    input.type="number"; input.id=s.id; input.min=s.min; input.max=s.max; input.value=s.default;
  }

  input.addEventListener("change", ()=>{
    risposte[s.id]=input.value;
    aggiornaRiepilogo();
    aggiornaImmagini();
  });

  wrapper.appendChild(input);
  container.appendChild(wrapper);
  aggiornaProgress();
}

document.getElementById("nextBtn").addEventListener("click",()=>{
  const s = steps[step];
  const val = document.getElementById(s.id).value;
  if(val===""){ alert("Seleziona un valore"); return; }
  risposte[s.id]=val;
  step++;
  mostraStep();
});

function aggiornaRiepilogo(){
  document.getElementById("sum_marca").textContent="Marca: "+(risposte["marca"]||"-");
  document.getElementById("sum_modello").textContent="Modello: "+(risposte["modello"]||"-");
  document.getElementById("sum_memoria").textContent="Memoria: "+(risposte["memoria"]||"-");
  document.getElementById("sum_batteria").textContent="Batteria: "+(risposte["batteria"]||"-");
  document.getElementById("sum_funzioni").textContent="Funzioni: "+(risposte["funzioni"]||"-");
  document.getElementById("sum_display").textContent="Display: "+(risposte["display"]||"-");
  document.getElementById("sum_retro").textContent="Retro: "+(risposte["retro"]||"-");
  document.getElementById("sum_account").textContent="Account: "+(risposte["account"]||"-");
}

function aggiornaProgress(){
  const perc = Math.round((step/steps.length)*100);
  document.getElementById("progress").style.width=perc+"%";
}

function aggiornaImmagini(){
  // Logo marca
  const logoMap = {
    "Apple":"https://ramservice.altervista.org/ValutazioneUsato/Loghi/logoapple.png",
    "Samsung":"https://ramservice.altervista.org/ValutazioneUsato/Loghi/logosamsung.png"
  };
  document.getElementById("logoMarca").src = risposte["marca"] ? logoMap[risposte["marca"]] : "";
  // Foto prodotto
  const riga = data.find(d=>d.Marca===risposte["marca"] && d.Modello===risposte["modello"]);
  document.getElementById("fotoProdotto").src = riga ? riga.Foto : "";
}

function calcolaPrezzo(){
  const riga = data.find(d=>d.Marca===risposte["marca"] && d.Modello===risposte["modello"] && d.Memoria===risposte["memoria"]);
  if(!riga){ alert("Combinazione non trovata!"); return; }
  let prezzo = riga.PrezzoBase;

  const batteria = parseFloat(risposte["batteria"]);
  if(batteria<85) prezzo *= 0.72;

  if(risposte["funzioni"]==="No, funziona parzialmente") prezzo *= 0.5;

  switch(risposte["display"]){
    case "No, ha il display rotto": prezzo *=0.2; break;
    case "Si, ma presenta graffi ben visibili": prezzo *=0.75; break;
    case "Si, ma graffi impercettibili": prezzo *=0.93; break;
  }

  switch(risposte["retro"]){
    case "Il vetro è crepato": prezzo *=0.5; break;
    case "Integro ma presenta graffi": prezzo *=0.75; break;
  }

  if(risposte["account"]==="No") prezzo*=0.2;

  document.getElementById("priceBox").textContent="€ "+prezzo.toFixed(2);
}

function ricomincia(){
  step=0;
  risposte={};
  document.getElementById("priceBox").textContent="Prezzo Valutazione";
  document.getElementById("nextBtn").style.display="inline-block";
  document.getElementById("showPriceBtn").style.display="none";
  aggiornaRiepilogo();
  aggiornaImmagini();
  mostraStep();
}

caricaCSV();

/* --- Piccola aggiunta VISIVA: forza il riepilogo ad allinearsi in altezza alla colonna sinistra --- */
function adjustHeights(){
  try{
    const left = document.getElementById('stepsCol');
    const right = document.getElementById('summaryCol');
    if(!left || !right) return;
    // Reset minHeight to recalc
    right.style.minHeight = '';
    // compute left height
    const leftRect = left.getBoundingClientRect();
    // add small margin to be safe
    const desired = Math.ceil(leftRect.height) + 2;
    right.style.minHeight = desired + 'px';
  }catch(e){
    // silent
  }
}

// run after load and when content changes
window.addEventListener('load', ()=>{ setTimeout(adjustHeights,120); });
window.addEventListener('resize', ()=>{ setTimeout(adjustHeights,80); });

// observe changes inside stepContainer (when steps change)
const stepContainer = document.getElementById('stepContainer');
if(stepContainer){
  const mo = new MutationObserver(()=> setTimeout(adjustHeights,60));
  mo.observe(stepContainer, {childList:true, subtree:true, attributes:true, characterData:true});
}

// also periodically run a couple times in the first seconds to catch async changes
setTimeout(adjustHeights,500);
setTimeout(adjustHeights,1200);
</script>
</body>
</html>
